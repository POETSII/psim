## POETS Simulator (`psim`)

### Getting Started

After installing `psim`, you can run a quick simulation of one of the
applications in the directory `tests`. For example, the file
`tests/basic-01.xml` can be simulated as follows:

```
$ ./psim.py tests/basic-01.xml
0 -> App [device0, 1]: Sending message 1
0 -> App [device1, 1]: Received message 1
0 -> App [device0, 1]: Sending message 2
0 -> App [device1, 1]: Received message 2
0 -> App [device0, 1]: Sending message 3
0 -> App [device1, 1]: Received message 3
0 -> App [device0, 1]: Sending message 4
0 -> App [device1, 1]: Received message 4
0 -> App [device0, 1]: Sending message 5
0 -> App [device1, 1]: Received message 5
0 -> App [device0, 1]: Sending message 6
0 -> App [device1, 1]: Received message 6
0 -> App [device0, 1]: Sending message 7
0 -> App [device1, 1]: Received message 7
0 -> App [device0, 1]: Sending message 8
0 -> App [device1, 1]: Received message 8
0 -> App [device0, 1]: Sending message 9
0 -> App [device1, 1]: Received message 9
0 -> App [device0, 1]: Sending message 10
0 -> App [device1, 1]: Received message 10
0 -> App [device1, X]: handler_exit(0) called
0 -> Metric [Delivered messages]: 10
0 -> Metric [Exit code]: 0
0 -> State [device0]: counter = 10
0 -> State [device1]: counter = 10
0 ->
```

#### Interpreting `psim`'s Output

The main output of the simulator is a printout of log messages generated by
`handler_log` calls, shown above as

```
i -> App [Device Name, Log Level] (log message)
```

as well as other information (simulation metrics and final device states) in
the following form

```
i -> Metric [Name]: Value
i -> State [Device Name]: Field = Value
```

The index `i` indicates the originating simulation engine instance. The
example `basic-01.xml` contains two devices and these are simulated by the
same instance (called `0`) in the above log, and so all log messages are
prefixed with `0 ->`.


#### Running Distributed Simulations

By default, `psim` will invoke a single engine instance to simulate all
devices. Running a distributed simulation requires providing a map file, in
JSON format, that maps device names to non-negative integers referred to as
"simulation regions".

For example, the following mapping file `map1.json`

```json
{
    "device0": 0,
    "device1": 1
}
```

 can be passed to `psim` by executing

 ```
 ./psim.py --map map1.json tests/basic-01.xml
 ```

which will produce the following output

```
0 -> App [device0, 1]: Sending message 1
0 -> App [device0, 1]: Sending message 2
0 -> App [device0, 1]: Sending message 3
0 -> App [device0, 1]: Sending message 4
0 -> App [device0, 1]: Sending message 5
0 -> App [device0, 1]: Sending message 6
0 -> App [device0, 1]: Sending message 7
0 -> App [device0, 1]: Sending message 8
0 -> App [device0, 1]: Sending message 9
0 -> App [device0, 1]: Sending message 10
1 -> App [device1, 1]: Received message 1
1 -> App [device1, 1]: Received message 2
1 -> App [device1, 1]: Received message 3
1 -> App [device1, 1]: Received message 4
1 -> App [device1, 1]: Received message 5
1 -> App [device1, 1]: Received message 6
1 -> App [device1, 1]: Received message 7
1 -> App [device1, 1]: Received message 8
1 -> App [device1, 1]: Received message 9
0 -> Received external shutdown command
0 -> Metric [Delivered messages]: 10
1 -> App [device1, 1]: Received message 10
0 -> Metric [Exit code]: 0
1 -> App [device1, X]: handler_exit(0) called
0 -> State [device0]: counter = 10
1 -> Metric [Delivered messages]: 20
1 -> Metric [Exit code]: 0
0 ->
1 -> State [device1]: counter = 10
1 ->
```

This log has similar content to the previous one but is generated by two
engine instances that communicate through Redis as explained in [How it
works](how-it-works.md).
